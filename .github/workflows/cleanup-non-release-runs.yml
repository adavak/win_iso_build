name: Test Clean Workflow Runs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'

jobs:
  check-runs:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch workflow runs and releases
        run: |
          echo "Fetching workflow runs..."
          gh api repos/${{ github.repository }}/actions/runs > runs.json
          echo "Fetching release tags..."
          gh api repos/${{ github.repository }}/releases -q '.[].tag_name' > release_tags.txt

      - name: Check workflow runs against releases
        run: |
          for run_id in $(jq -r '.workflow_runs[].id' runs.json); do
            run_name=$(jq -r ".workflow_runs[] | select(.id==$run_id) | .name")
            run_branch=$(jq -r ".workflow_runs[] | select(.id==$run_id) | .head_branch")
            echo "Checking run $run_id -> branch $run_branch / name $run_name"

            # 找匹配 release tag
            matched_release=$(grep -E "$run_name|$run_branch" release_tags.txt || true)

            if [ -z "$matched_release" ]; then
                echo "⚠️ Workflow run $run_id has NO release tag"
            else
                release_note=$(gh api repos/${{ github.repository }}/releases/tags/$matched_release -q '.body')
                if ! echo "$release_note" | grep -q "SHA256"; then
                    echo "⚠️ Workflow run $run_id has release but NO SHA256"
                else
                    echo "✅ Workflow run $run_id has SHA256"
                fi
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
