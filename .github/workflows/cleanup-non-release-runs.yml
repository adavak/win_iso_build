name: Cleanup Short Workflow Runs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Fetch recent workflow runs
        run: |
          echo 'Fetching workflow runs...'
          curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=50 \
            > runs.json
          echo "Saved workflow runs to runs.json"

      - name: Delete short workflow runs (<10 minutes)
        run: |
          echo 'Deleting workflow runs with duration < 10 minutes...'
          
          # Extract run ID, start time, end time
          jq -r '.workflow_runs[] | "\(.id) \(.run_started_at) \(.updated_at)"' runs.json > runs_times.txt
          
          threshold=600  # 10 minutes in seconds
          
          while read run_id start_time end_time; do
              # Convert to Unix timestamps
              start_ts=$(date -d "$start_time" +%s)
              end_ts=$(date -d "$end_time" +%s)
              duration=$((end_ts - start_ts))
              
              if [ $duration -lt $threshold ]; then
                  # ⚠️ Warning for short run
                  echo $'\u26A0\ufe0f Workflow run '"$run_id"' duration '"$duration"' seconds < '"$threshold"', deleting...'
                  curl -s -X DELETE -H "Authorization: token $GH_TOKEN" \
                    "https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id"
              else
                  # ✅ Keep run
                  echo $'\u2705 Workflow run '"$run_id"' duration '"$duration"' seconds, keep'
              fi
          done < runs_times.txt
