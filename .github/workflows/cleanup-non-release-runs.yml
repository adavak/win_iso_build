name: Test Workflow Runs by Artifact

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'  # 每3小时运行一次

jobs:
  check-runs:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch workflow runs
        run: |
          echo "Fetching workflow runs..."
          gh api repos/${{ github.repository }}/actions/runs?per_page=50 > runs.json
          echo "Saved workflow runs to runs.json"

      - name: Fetch releases
        run: |
          echo "Fetching all releases..."
          gh api repos/${{ github.repository }}/releases > releases.json
          echo "Saved releases to releases.json"

      - name: Check workflow runs by artifact
        run: |
          echo "Checking workflow runs..."
          for run_id in $(jq -r '.workflow_runs[].id' runs.json); do
              echo "Checking run $run_id ..."

              # 获取该 run 的 artifacts
              gh api repos/${{ github.repository }}/actions/runs/$run_id/artifacts > artifacts.json
              artifact_name=$(jq -r '.artifacts[0].name // empty' artifacts.json)

              if [ -z "$artifact_name" ]; then
                  echo "⚠️ Workflow run $run_id has no artifacts, skipping..."
                  continue
              fi

              # 匹配 release tag
              matched_release=$(jq -r --arg name "$artifact_name" '.[] | select(.tag_name==$name) | .tag_name' releases.json)

              if [ -z "$matched_release" ]; then
                  echo "⚠️ Workflow run $run_id artifact $artifact_name has no corresponding release"
              else
                  release_note=$(jq -r --arg tag "$matched_release" '.[] | select(.tag_name==$tag) | .body' releases.json)
                  if echo "$release_note" | grep -q "ISO SHA256:"; then
                      echo "✅ Workflow run $run_id artifact $artifact_name has ISO SHA256"
                  else
                      echo "⚠️ Workflow run $run_id artifact $artifact_name release has no ISO SHA256"
                  fi
              fi
          done
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
