name: Test Clean Workflow Runs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'

jobs:
  check-runs:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Check runs without SHA256 release note
        run: |
          echo "Fetching workflow runs..."
          # 获取最近的 workflow runs
          gh api repos/${{ github.repository }}/actions/runs \
            -q '.workflow_runs[] | {id: .id, head_branch: .head_branch, head_sha: .head_sha, name: .name, created_at: .created_at}' \
            > runs.json

          echo "Checking each workflow run:"
          for run_id in $(jq -r '.[].id' runs.json); do
            run_sha=$(jq -r ".[] | select(.id==$run_id) | .head_sha" runs.json)
            echo "Run $run_id -> SHA $run_sha"

            # 找这个 tag 是否有关联 release
            release_body=$(gh api repos/${{ github.repository }}/releases \
              -q ".[] | select(.tag_name == \"${run_sha}\") | .body" || echo "")

            if [ -z "$release_body" ] || ! echo "$release_body" | grep -q "SHA256"; then
              echo "⚠️ $run_id has NO SHA256 release note"
            else
              echo "✅ $run_id has SHA256"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
