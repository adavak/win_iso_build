name: Test Clean Workflow Runs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'

jobs:
  check-runs:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Check workflow runs without SHA256 release note
        run: |
          echo "Fetching workflow runs..."
          # 获取 workflow runs
          gh api repos/${{ github.repository }}/actions/runs > runs.json

          echo "Checking each workflow run:"
          # 遍历 workflow_runs 数组
          for run_id in $(jq -r '.workflow_runs[].id' runs.json); do
            run_sha=$(jq -r ".workflow_runs[] | select(.id==$run_id) | .head_sha" runs.json)
            echo "Run $run_id -> SHA $run_sha"

            # 查询对应 release note
            release_body=$(gh api repos/${{ github.repository }}/releases \
              -q ".[] | select(.tag_name==\"${run_sha}\") | .body" || echo "")

            if [ -z "$release_body" ] || ! echo "$release_body" | grep -q "SHA256"; then
              echo "⚠️ Workflow run $run_id has NO SHA256 release note"
            else
              echo "✅ Workflow run $run_id has SHA256"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
