name: Check Workflow Run Duration

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'

jobs:
  check-duration:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Fetch workflow runs
        run: |
          echo "Fetching workflow runs..."
          gh api repos/${{ github.repository }}/actions/runs?per_page=50 > runs.json
          echo "Saved workflow runs to runs.json"

      - name: Check run duration
        run: |
          echo "Checking workflow run durations..."
          
          jq -r '.workflow_runs[] | "\(.id) \(.run_started_at) \(.updated_at)"' runs.json > runs_times.txt
          
          threshold=600  # 10分钟, 小于10分钟认为无效
          
          while read run_id start_time end_time; do
              start_ts=$(date -d "$start_time" +%s)
              end_ts=$(date -d "$end_time" +%s)
              duration=$((end_ts - start_ts))
              
              if [ $duration -lt $threshold ]; then
                  echo "⚠️ Workflow run $run_id duration $duration seconds < $threshold, likely invalid"
              else
                  echo "✅ Workflow run $run_id duration $duration seconds, valid"
              fi
          done < runs_times.txt
